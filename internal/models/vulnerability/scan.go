package vulnerability

import (
	"fmt"
	"time"

	"github.com/NucleoFusion/cruise/internal/colors"
	"github.com/NucleoFusion/cruise/internal/config"
	"github.com/NucleoFusion/cruise/internal/messages"
	"github.com/NucleoFusion/cruise/internal/runtimes/docker"
	"github.com/NucleoFusion/cruise/internal/styles"
	"github.com/charmbracelet/bubbles/viewport"
	tea "github.com/charmbracelet/bubbletea"
	"github.com/charmbracelet/lipgloss"
)

type ScanList struct {
	Width         int
	Height        int
	Vp            viewport.Model
	Scanners      []string
	Found         []bool
	Focused       bool
	SelectedIndex int
	IsLoading     bool
}

func NewScanList(w int, h int) *ScanList {
	vp := viewport.New(w, h)
	vp.Style = lipgloss.NewStyle().Border(lipgloss.RoundedBorder()).BorderForeground(colors.Load().FocusedBorder).
		Padding(1).Foreground(colors.Load().Text)

	return &ScanList{
		Width:     w,
		Height:    h,
		Vp:        vp,
		Scanners:  []string{"trivy", "grype"},
		IsLoading: true,
	}
}

func (s *ScanList) Init() tea.Cmd {
	return tea.Tick(0, func(_ time.Time) tea.Msg {
		arr := make([]bool, 0, len(s.Scanners))
		for _, v := range s.Scanners {
			arr = append(arr, docker.ScannerAvailable(v))
		}

		return messages.ScannerListMsg{
			Found: arr,
		}
	})
}

func (s *ScanList) Update(msg tea.Msg) (*ScanList, tea.Cmd) {
	switch msg := msg.(type) {
	case messages.ScannerListMsg:
		s.Found = msg.Found
		s.IsLoading = false
		return s, nil
	case tea.KeyMsg:
		switch msg.String() {
		case config.Cfg.Keybinds.Global.ListDown:
			if s.SelectedIndex < len(s.Scanners)-1 {
				s.SelectedIndex++
			}
			return s, nil
		case config.Cfg.Keybinds.Global.ListUp:
			if s.SelectedIndex > 0 {
				s.SelectedIndex--
			}
			return s, nil
		}
	}
	return s, nil
}

func (s *ScanList) View() string {
	s.Vp.Style = s.Vp.Style.BorderForeground(colors.Load().UnfocusedBorder)
	if s.Focused {
		s.Vp.Style = s.Vp.Style.BorderForeground(colors.Load().FocusedBorder)
	}

	if s.IsLoading {
		return styles.PageStyle().BorderForeground(colors.Load().UnfocusedBorder).Render(lipgloss.Place(s.Width-2, s.Height-2, lipgloss.Center, lipgloss.Top, "Loading..."))
	}

	s.UpdateText()

	return lipgloss.Place(s.Width, s.Height, lipgloss.Center, lipgloss.Top, s.Vp.View())
}

func (s *ScanList) UpdateText() {
	text := lipgloss.PlaceHorizontal(s.Width-2, lipgloss.Center, styles.TitleStyle().Render("Supported Scanners")) + "\n\n\n"
	for k, v := range s.Scanners {
		line := v
		if !s.Found[k] {
			line = fmt.Sprintf("%s - %s", v, styles.ErrorStyle().Render("Not Found"))
		}

		if s.SelectedIndex == k {
			line = styles.SelectedStyle().Width(s.Width - 2).Render(line)
		} else {
			line = lipgloss.NewStyle().Width(s.Width - 2).Render(line)
		}

		text += line + "\n"
	}

	s.Vp.SetContent(text)
}

func (s *ScanList) GetSelected() (string, bool) {
	return s.Scanners[s.SelectedIndex], s.Found[s.SelectedIndex]
}
